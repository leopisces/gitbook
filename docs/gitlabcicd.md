# GitLab CICD

## 一、基本介绍

### 1.1 为什么要做CI/CD？

**传统应用发布模式**  
![](/pics/2.png)

开发团队  
在开发环境中完成软件开发，单元测试，测试通过，提交到代码版本管理库。

运维团队  
把应用部署到测试环境，供QA团队测试，测试通过后部署生产环境

QA团队  
进行测试，测试通过后通知部署人员发布到生产环境

**面临挑战**  
1. 错误发现不及时   
   很多错误在项目的早期可能存在，到最后集成的时候才发现问题
2. 人工低级错误发生  
   产品和服务交付中的关键活动全都需要手动操作
3. 团队工作效率低  
   需要等待他人的工作完成后才能进行自己的工作
4. 开发运维对立  
   开发人员想要快速更新，运维人员追求稳定，各自的针对的方向不同

### 1.2 CI/CD

**持续集成（CI）**  
- 合并开发人员正在开发编写的所有代码的一种做法
- 通常一天内进行多次合并和提交代码
- 从存储库或生产环境中进行构建和自动化测试，以确保没有继承问题并及早发现任何问题

**持续交付（CD）**  
- 通常可以通过将更改自动推送到发布系统来随时将软件发布到生产环境中
- 持续部署会更进一步，并自动将更改推送到生产中

**解决问题**  
- CI
    - 尽快发现错误
    - 减少集成问题
    - 避免复杂问题
- CD
    - 每次更改都可发布
    - 降低每次发布风险
    - 更加频繁交付价值
    - 快速频繁客户反馈

### 1.3 持续集成-Jenkins
- 可扩展自动化服务器
- 安装配置简单
- 丰富的插件库
- 分布式架构设计
- 支持所有平台
- 可视化的管理页面

### 1.4 代码版本管理-GitLab
- 代码审查
- 问题跟踪
- 动态订阅
- 易于扩展
- 项目wiki
- 多角色项目管理
- 项目代码在线预览
- CI工具集成

#### 1.4.1 GitLab 内置持续集成
**持续集成（CI）**  
- 集成团队中每个开发人员提交的代码到代码库存储库
- 开发人员在Merge或者Pull请求中合并拉取新代码
- 在提交或者合并更改到代码库之前，会触发了构建，测试和新代码验证的管道
- CI可帮助您在开发周期的早期发现并减少错误

**持续交付（CD）**  
- 可通过结构化的部署管道确保将经过CI验证的代码交付给您的应用程序
- CD可以将经过验证的代码更快地移至您的应用程序

CI/CD一起可以加快团队为客户和利益相关者交付成果的速度。CI和CD必须无缝协作，以使您的团队快速有效地进行构建，并且对于确保完全优化的开发实践至关重要。

**优势**  
- 开源：CI/CD是开源GitLab社区版和专有Gitlab企业版的一部分
- 易于学习：具有详细的入门文档
- 无缝集成：Gitlab CI/CD是GitLab的一部分，支持从计划到部署，具有出色的用户体验。
- 可扩展：测试可以在单独的计算机上分布式运行，可以根据需要添加任意数量的计算机。
- 更快的结果：每个构建可以拆分为多个作业，这些作业可以在多台计算机上并行运行。
- 针对交付进行了优化：多个阶段，手动部署，环境和变量

**特点**  
- 多平台：Unix，Windows，macOS和任何其他支持Go的平台上执行构建
- 多语言：构建脚本是命令行驱动的，并且可以与Java，PHP，Ruby，C和任何其他语言一起使用
- 稳定构建：构建在与GitLab不同的机器上运行
- 并行构建：GitLab CI/CD在多台机器上拆分构建，以实现快速执行
- 实时日志记录：合并请求中的链接将您带到动态更新的当前构建日志
- 灵活的管道：您可以在每个阶段定义多个并行作业，并且可以触发其他构建
- 版本管道：一个.gitlab-ci.yml包含你的测试，整个过程的步骤，使每个人都能贡献更改，并确保每个分支的所需的管道。
- 自动缩放：可以自动缩放构建机器，以确保立即处理您的构建并将成本降至最低。
- 构建工件：可以将二进制文件和其他构建工件上载到GitLab并浏览和下载他们
- Docker支持：可以使用自定义Docker映像，作为测试的一部分启动服务，构建新的Docker映像，甚至可以在Kubernetes上运行
- 容器注册表：内置的容器注册表，用于存储，共享和使用容器映像。
- 受保护的变量：在部署期间使用受每个环境保护的变量安全地存储和使用机密
- 环境：定义多个环境

#### 1.4.2 GitLab CI/CD组件
- GitLab CI/CD
    - GitLab的一部分，GitLab是一个Web应用程序，具有将其状态存储在数据库中的API
    - 除了GitLab的所有功能之外，它还管理项目/构建并提供一个不错的用户界面
- GitLab Runner
    - 是一个处理构建的应用程序
    - 它可以单独部署，并通过API与GitLab CI/CD一起使用
- .gitlab-ci.yml
- 为了运行测试，至少需要一个GitLab实例和一个GitLabRunner

#### 1.4.3 GitLab CI/CD工作原理
- 将代码托管到Git存储库
- 在项目根目录创建ci文件.gitlab-ci.yml，在文件中指定构建，测试和部署脚本
- GitLab将检测到它并使用名为GitLab Runner的工具运行脚本。
- 脚本被分组为作业，他们共同组成了一个管道。


## 二、GitLabCI与JenkinsCI对比

### 2.1 Jenkins
Jenkins是一个广泛用于持续集成的可视化web自动化工具，jenkins可以很好的支持和各种语言的项目构建，也完全兼容ant、maven、grad了、等多种第三方构建工具、同时跟svn、git能无缝集成、也支持直接与知名源代码托管网站，比如github、bitbucket直接集成，而且插件众多，在这么多年的技术积累之后，在国内大部分公司都使用Jenkins。

### 2.2 GitLabCI/CD
gitlab-CI是gitlab8.0之后自带的一个持续集成系统，中心思想是当每一次push到gitlab的时候，都会触发一次脚本执行，然后脚本的内容包括了测试，编译，部署等一系列自定义的内容。

gitlab-CI的脚本执行，需要自定义安装对应gitlab-runner来执行，代码bush之后，webhook检测到代码变化，就会触发gitlab-CI，分配到各个Runner来运行相应的脚本script。这些脚本有的是测试项目用的，有的是部署用的。

### 2.3 对比
- 分支可配置性
    - 使用GitLab CI，新创建的分支无需任何一步配置即可立即使用CI管道中已定义的作业
    - Jenkins 2基于gitlab的多分支流水线可以实现。相对配置来说gitlab更加方便一些
- 定时执行构建
    - 有时，根据时间触发作业或整个管道会有所帮助。例如，常规的夜间定时构建。
    - 使用Jenkis2可以立即使用。可以在应执作业或管道的那一刻以cron式语法定义
    - GitLab没有此功能。但是，可以通过一种变通的办法来实现：通过WebAPI使用同一台或另一台服务器上的cronjob触发作业和管道  

      尽管使用GitLab CI无法做到这一点，其实如果配置了提交代码即触发流水线，那么最后一次提交的构建在什么时候没有什么不同，反而减少未提交代码的定时构建资源浪费。
- 拉去请求支持
    - 如果很好地集成了存储库管理和CI/CD平台，您可以看到请求的当前构建状态。使用这种功能，可以避免将代码合并到不起作用或无法正确构建的主分支中。
    - Jenkins 没有与源代码管理系统进一步集成，需要管理员自行写代码或者插件实现。
    - GitLab与其CI平台紧密集成，可以方便查看每个打开和关闭拉动请求的运行和完成管道。
- 权限管理
    - 由于GitLab与GitLabCI的深度整合，权限可以统一管理。
    - 由于Jenkins 2没有内置的存储库管理器，因此他无法直接在存储库管理器和CI/CD平台之间合并权限。
- 存储库交互
    - GitLab是Git存储库管理器GitLab的固定组件，因此在CI/CD流程和存储库功能之间提供了良好的交互
    - Jenkins 2与存储库管理器都是松散耦合的，因此在选择版本控制系统时它非常灵活。此外，就像其前身一样，Jenkins 2强调了对插件的支持,以进一步扩展或改善软件的现有功能。
- 插件管理
    - 扩展Jenkins的本机功能是通过插件完成的。插件的维护，保护和升级成本很高。
    - GitLab是开放式的，任何人都可以直接向代码库贡献更改，一旦合并，它将自动测试并维护每个更改

### 2.4 总结

| GitLabCI          | Jenkins             |
| ------------- | -------------- |
| 轻量级，不需要复杂的安装手段       | 编译服务和代码库分离，耦合度低 |
| 配置简单，与GitLab可直接适配       | 插件丰富，支持语言众多 |
| 实时构建日志十分清晰，UI交互体验很好       | 有统一的web管理界面 |
| 使用YAML进行配置，任何人都可以很方便的使用       | 插件以及本身安装较为复杂 |
| 没有统一的管理界面，无法统筹管理所有项目       | 体量较大，不适合小型团队 |
| 配置依赖于代码仓库，耦合度没有Jenkins低|       

GitLabCI 有助于DevOps人员，例如敏捷开发中，开发与运维是同一个人，最便捷的开发方式。  
JenkinsCI适合在角色团队中，职责分明、配置与代码分离、插件丰富。

## 三、GitLab Runner

### 3.1 简介
- GitLab Runner是一个开源项目，用于运行作业并将结果发送回GitLab。
- 与GitLabCI结合使用，GitLabCI是GitLab随附的用于协调作业的开源持续集成服务
- GitLab Runner是Go编写的，可以在Linux，macOS和Windows操作系统上运行
- 容器部署需要使用最新DOcker版本 >v1.13.0
- GitLab Runner版本与GitLab版本同步
- 可以根据配置任意数量的Runner

GitLab Runner类似于Jenkins的agent，执行CI持续集成构建的脚本任务

### 3.2 特点
- 作业运行控制：同时执行多个作业
- 作业运行环境
    - 在本地、使用Docker容器、使用Docker容器并通过ssh执行作业
    - 使用Docker容器在不同的云和虚拟化管理程序上自动缩放
    - 连接到远程ssh服务器
- 支持Bash、Windows Batch、和Windows PowerShell
- 允许自定义作业运行环境
- 自动重新加载配置，无需启动
- 易于安装，可作为Linux，macOS和Windows服务

### 3.3 类型
- shared 共享类型，运行整个平台项目的作业
- group 项目组类型，运行特定group下的所有项目的作业
- specific 项目类型，运行指定项目作业

### 3.4 状态
- locked：锁定状态，无法运行项目作业
- paused：赞停状态，暂时不会接受新的作业